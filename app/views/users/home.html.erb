<% if signed_in? %>
  <% current_color = randomColor() %>  
 
<script>
      
  $(document).ready(function() {
    

    $('.slideToggler2').click(function(){
      $('.slideContent2').slideToggle('slow');
      $(this).toggleClass('slideSign2');
      return false;
    });
    
    $('.collaps2').click(function(){
      $('.slideContent2').slideToggle('slow');
      $('.slideToggler2').toggleClass('slideSign2');
      return false;
    });
  


    $('#linkadd').click(function() {
      $('#micropost_content').after('<li><input type="text" id="url" name="url" placeholder="www..." maxlength="100" onBlur="makeShortFromTextInput()"/></li>');
      $('#linkadd').remove();
    });

    $('#imagelinkadd').click(function() {
      $('#micropost_content').after('<li><input type="text" id="imageurl" name="imageurl" placeholder="www...link to image (experimental)" maxlength="100" onBlur="checkImage()"/></li>');
      $('#imagelinkadd').remove(); 
    });


    $('#showSendMessage').click(function() {
      $('#showSendMessage').remove();
    });
    
  });
    
  function showSendMessage(){
    document.getElementById('sendMessage').setAttribute("class", "well sidebar-nav");
    
  }

  
  

  function buttonPress(userID){      
    var friend_id = "friends[" + userID + "]";
    var image_id = "image_"  + userID;
    var name_id = "name_"  + userID;
    //var select_id = "select_"  + userID;

    var visible = document.getElementById(friend_id).value;
    if(visible == "false"){        
      document.getElementById(image_id).setAttribute("class", "avatar_selected");   
      document.getElementById(name_id).setAttribute("class", "name_selected");
     // document.getElementById(select_id).setAttribute("class", "avatar_selected");       
      document.getElementById(friend_id).value = "true";
    }else{ 
      document.getElementById(image_id).setAttribute("class", "avatar_unselected");
      document.getElementById(name_id).setAttribute("class", "name_unselected"); 
     // document.getElementById(select_id).setAttribute("class", "avatar");
      document.getElementById(friend_id).value = "false";
    }  
  }
  

  function checkImage(){
    var imageurl = document.getElementById("imageurl").value;
    $("<img>", {
        src: imageurl,
        error: function() { 
          document.getElementById("imageurl").value = "Image link is not working :(";
        },
        load: function() { 
          document.getElementById("imageurl").value = "Image OK";
          document.getElementById("micropost_imagelink").value = imageurl;
        }
    });
  }

  function loadDropBoxListener(){
    loadURLShortener(); 
    document.getElementById("db-chooser").addEventListener("DbxChooserSuccess",
        function(e) {
            makeShort(e.files[0].link);
        }, false);
    }          

  
  function makeShortFromTextInput(){
    var longUrl = document.getElementById("url").value;
    makeShort(longUrl); 
  }

  function makeShort(longUrl) 
  {
       
     if (longUrl != null && longUrl.length > 0){
        var request = gapi.client.urlshortener.url.insert({
          'resource': {
          'longUrl': longUrl
        }
        });
        request.execute(function(response) 
        {    
            if(response.id != null){                

                document.getElementById("url").value = response.id;
                document.getElementById("micropost_weblink").value = response.id;
            }
        
     
        });
      }
   }

   
  function loadURLShortener()
  {
      //Get your own Browser API Key from  https://code.google.com/apis/console/
      gapi.client.setApiKey('AIzaSyCF1DzfpTiMuzKk2TjudaZ-bPIPGjaL6NY');
      gapi.client.load('urlshortener', 'v1',function(){});
   
  }
  window.onload = loadDropBoxListener;
   
</script>
<script src="https://apis.google.com/js/client.js"> </script>  
<script type="text/javascript" src="https://www.dropbox.com/static/api/1/dropins.js" id="dropboxjs" data-app-key="s0y1a8bft03ts1x"></script>       


<% if @visible_users.length > 0 %>
<div class="well" style="background-color:white;">
  
  <div class="row-fluid">
      <div class="span12">        
        <a href="<%=root_path%>"><%= image_tag("glyphicons_207_remove_2.png", style: "margin-left:20px;", size: "16x16")%></a>
      </div>  
      
  </div>
  
  <ul class="thumbnails">
    <li class="span4">
      <div class="thumbnail" style="margin:0px;border:0px;">
        <img src="<%=current_user.getAvatarURL%>" width="40" height="40">
        <h5 style="text-align:center;">You</h5>
      </div>
    </li>
    <% @visible_users.each do |u| %> 
      <li class="span4">
        <div class="thumbnail" style="margin:0px;border:0px;">
          <img  src="<%=u.getAvatarURL%>" width="40" height="40">
            <h5 style="text-align:center;"><%=u.name%></h5>   
            <% if !@friends.include?(u) %>
              <span style="text-align:center;">
                <%= form_for u, url: {id: current_user.id, action: "invite"}, html: {method: :post} do |f| %>
                  <%= f.hidden_field :email, value: u.email %>
                  <%= f.submit "Add", class: "btn" %>
                <% end %> 
              </span>  
            <% end %> 
        </div>
      </li>  
    <% end %>            
  </ul>
  
  </div>   
<% end %>

<div class="well sidebar-nav" style="background-color:white;">
  <div class="slideToggler2">
    <div class="nav nav-list">
      <li class="nav-header"><%= image_tag("glyphicons_010_envelope.png", size: "16x16")%> Compone new message <% if @visible_users.length > 0 %> to this group <% end %></li>
    </div>  
  </div> 


  <div class="slideContent2" style="display:none">
    <ul class="nav nav-list">  
      <% if @friends.length == 0 %>
        <li class="nav-header">You haven't added any friends yet. Add some!</li>
      <% else %>   
        <%= form_for(@micropost) do |f| %>  
          <%= f.hidden_field :filter, value: current_color %>
          <%= f.hidden_field :weblink %>
          <%= f.hidden_field :imagelink %>
          <li><%= render 'shared/error_messages', object: f.object %></li>   
          
          <li>
            <div class="row-fluid">
              <div class="span6"><%= f.text_field :content, placeholder: "Dont forget to buy milk!", maxlength: "100" %></div>
            </div>   
          </li>

          <li class="nav-header" >
            <div class="row-fluid">
              <div class="span2"><%= image_tag("glyphicons_050_link.png", size: "16x16")%> Add link (optional)</div>
              <div class="span2 offset2"><input type="dropbox-chooser" name="selected-file" id="db-chooser" /></div>  
            </div>
            <div class="row-fluid">
              <div class="span6"><input type="text" id="url" name="url" placeholder="www..." maxlength="100" onBlur="makeShortFromTextInput()"/></div>
            </div>  
          <li>
            
          
          <% if @visible_users.length == 0 %>
            <li class="nav-header">Visible to</li>
            <li><table style="margin-top:0px;margin-bottom:0px;white-space:nowrap;">
            <tr><td><img src="<%=current_user.getAvatarURL%>" class="avatar_selected" width="24" height="24"><span class="name_selected"> You</span></td></tr> 
 
            <%  @friends.each do |u| %>          
               <tr>
                <td><a class="noline" href="#" onClick=buttonPress('<%=u.id%>')><img src="<%=u.getAvatarURL%>" id="image_<%=u.id%>" class="avatar_unselected" width="24" height="24"><span id="name_<%=u.id%>" class="name_unselected"> <%= u.name %></span></a>
                </td>
              </tr>            
               <input type="hidden" id="friends[<%=u.id%>]" name="friends[<%=u.id%>]" value="false"/> 
            <% end %> 
          <% else %>
              <%  @visible_users.each do |u| %>
                <input type="hidden" id="friends[<%=u.id%>]" name="friends[<%=u.id%>]" value="true"/> 
             <% end %> 
          <% end %>  

          </table></li>
          <li style="margin-top:20px">
            <%= f.submit "Share", class: "btn btn-success" %>
          </li>
        <% end %> 
      <% end %> 
    
    <% if @visible_users.length == 0 %>
      <hr>
      <ul class="nav nav-list"> 
          <li class="nav-header"><%= image_tag("glyphicons_006_user_add.png", size: "16x16")%> Add somebody</li>  
          <%= form_for @friend, url: {id: current_user.id, action: "invite" } do |f| %>
          <div class="row-fluid"><div class="span6"><%= f.email_field :email, placeholder: "Email" %></div><div class="span2"><%= f.submit "Add", class: "btn" %></div></div>
        <% end %> 
      </ul>
    <% end %>
  </div>
</div>


  

  <div>
    <%  @microposts.each do |micropost| %> 
      <div class="row-fluid">
      <div class="span12">
      <%= render micropost %>
      </div> 
     </div>  
    <% end %>
  </div>


<% else %>
  <div class="center hero-unit" style="background-color: #ffffff;margin-left:0px;margin-right:0px;">
    <h1>Private sharing: faster</h1>     
    <p>
      All messages on Lugogram are private to and from your close friends. Not companies. Not ads. Not old school mates. 
      The contents of messages are private forever (and will never be used to target adverticing).
    </p>
    </br>
    <p>Its a lot like email but easier to use: Private sharing the way it's suppose to be.</p>
    <p><%= link_to "Sign up now, it's free", signup_path, class: "btn btn-large btn-success" %></p> 
  </div>
  <div class="row-fluid">
  <%= render 'shared/lugogram_message', avatar: defaultAvatar, name: 'Julia', time: "", visibility: "", message:'Thanks for the dinner yesterday, the food was fantastic!', weblink: "", imagelink: "", color: randomColor() %>
  <%= render 'shared/lugogram_message', avatar: defaultAvatar, name: 'Lisa', time: "", visibility: "", message:'We are leaving for the pizza place now, feel free to join.', weblink: "", imagelink: "", color: randomColor() %>
  <%= render 'shared/lugogram_message', avatar: defaultAvatar, name: 'Ben', time: "", visibility: "", message:'Dont forget the milk!', weblink: "", imagelink: "", color: randomColor() %> 
  <%= render 'shared/lugogram_message', avatar: defaultAvatar, name: 'Martin', time: "", visibility: "", message:'Bootstrap link: http://twitter.github.io/bootstrap/components.html#thumbnails', weblink: "", imagelink: "", color: randomColor() %>
  </div>
<% end %> 